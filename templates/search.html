{% extends "base.html" %}

{% block title %}Search Candidates - AI Recruiter{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1><i class="fas fa-search"></i> Find Best Candidates</h1>
        <p>Match candidates to your job requirements</p>
    </div>

    <div class="search-section">
        <div class="job-form">
            <div class="form-group">
                <label for="jobTitle">Job Title</label>
                <input type="text" id="jobTitle" class="form-control" placeholder="e.g., Senior Software Engineer">
            </div>

            <div class="form-group">
                <label for="jobDescription">Job Description</label>
                <textarea id="jobDescription" class="form-control" rows="10" 
                          placeholder="Paste or type your job description here..."></textarea>
            </div>

            <div id="extractedRequirements" class="requirements-box" style="display: none;">
                <h3><i class="fas fa-list-check"></i> Key Requirements (Auto-extracted)</h3>
                <div id="requirementsList" class="requirements-list"></div>
            </div>

            <button id="extractBtn" class="btn btn-secondary" onclick="extractRequirements()">
                <i class="fas fa-magic"></i> Extract Requirements
            </button>
            
            <button id="searchBtn" class="btn btn-primary" onclick="searchCandidates()">
                <i class="fas fa-search"></i> Search Candidates
            </button>
        </div>

        <div id="loadingIndicator" class="loading-indicator" style="display: none;">
            <div class="spinner"></div>
            <p id="loadingText">Analyzing job requirements...</p>
        </div>

        <div id="searchProgress" class="search-progress" style="display: none;">
            <div class="progress-header">
                <div class="progress-icon">
                    <i class="fas fa-search"></i>
                </div>
                <div class="progress-text">
                    <h3>Finding Best Candidates</h3>
                    <p id="progressDescription">Our AI agents are working to find the perfect matches for your role<span class="dots-animation"></span></p>
                </div>
            </div>
            
            <div class="progress-bar-container">
                <div id="progressBarFill" class="progress-bar-fill" style="width: 0%"></div>
            </div>
            
            <div class="progress-steps">
                <div class="progress-step" id="step-analyzing">
                    <div class="step-icon">1</div>
                    <div class="step-text">Analyzing job requirements and extracting key criteria</div>
                </div>
                <div class="progress-step" id="step-searching">
                    <div class="step-icon">2</div>
                    <div class="step-text">Searching resume database using semantic matching</div>
                </div>
                <div class="progress-step" id="step-ranking">
                    <div class="step-icon">3</div>
                    <div class="step-text">Ranking candidates and analyzing fit scores</div>
                </div>
                <div class="progress-step" id="step-finalizing">
                    <div class="step-icon">4</div>
                    <div class="step-text">Finalizing results and generating detailed insights</div>
                </div>
            </div>
        </div>

        <div id="searchResults" class="search-results" style="display: none;">
            <h2>Top Matches</h2>
            <div id="resultsContainer"></div>
        </div>

        <!-- Email Draft Side Pane -->
        <div id="emailSidePane" class="email-side-pane" style="display: none;">
            <div class="pane-header">
                <h3><i class="fas fa-envelope"></i> Email Draft</h3>
                <button class="close-btn" onclick="closeEmailPane()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="pane-content">
                <div id="emailLoadingIndicator" class="loading-indicator" style="display: none;">
                    <div class="spinner"></div>
                    <p id="emailLoadingText">Creating personalized email...</p>
                </div>
                
                <div id="emailDraftContent" style="display: none;">
                    <div class="email-preview">
                        <div class="form-group">
                            <label for="emailSubject"><strong>Subject:</strong></label>
                            <input type="text" id="emailSubject" class="form-control" placeholder="Email subject line...">
                        </div>
                        
                        <div class="form-group">
                            <label for="emailBody"><strong>Message:</strong></label>
                            <textarea id="emailBody" class="form-control" rows="12" placeholder="Email message body..."></textarea>
                        </div>
                        
                        <div class="time-slots-section">
                            <h4><i class="fas fa-calendar"></i> Available Time Slots:</h4>
                            <div id="timeSlotsList" class="time-slots-list"></div>
                        </div>
                        
                        <div class="edit-actions">
                            <div class="edit-info">
                                <i class="fas fa-info-circle"></i>
                                <span>You can edit the subject and message above</span>
                            </div>
                        </div>
                        
                        <div class="pane-actions">
                            <button class="btn btn-primary" onclick="copyEmailDraft()">
                                <i class="fas fa-copy"></i> Copy Draft
                            </button>
                            <button class="btn btn-secondary" onclick="sendEmail()">
                                <i class="fas fa-paper-plane"></i> Send Email
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="emailErrorMessage" class="error-message" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="emailErrorText"></span>
                </div>
            </div>
        </div>
        
        <!-- Backdrop for side pane -->
        <div id="emailPaneBackdrop" class="pane-backdrop" style="display: none;" onclick="closeEmailPane()"></div>

        <div id="errorMessage" class="error-message" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="errorText"></span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentSearchId = null;
let searchCheckInterval = null;

function extractRequirements() {
    const jobDescription = document.getElementById('jobDescription').value;
    
    if (!jobDescription.trim()) {
        showError('Please enter a job description first');
        return;
    }

    fetch('/api/extract_requirements', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            job_description: jobDescription
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.requirements && data.requirements.length > 0) {
            displayRequirements(data.requirements);
        } else {
            showError('Could not extract requirements');
        }
    })
    .catch(error => {
        showError('Failed to extract requirements: ' + error.message);
    });
}

function displayRequirements(requirements) {
    const container = document.getElementById('requirementsList');
    container.innerHTML = '';
    
    requirements.forEach(req => {
        const item = document.createElement('div');
        item.className = 'requirement-item';
        item.innerHTML = `
            <i class="fas fa-check"></i>
            <span>${req}</span>
        `;
        container.appendChild(item);
    });
    
    document.getElementById('extractedRequirements').style.display = 'block';
}

function searchCandidates() {
    const jobTitle = document.getElementById('jobTitle').value;
    const jobDescription = document.getElementById('jobDescription').value;
    
    if (!jobDescription.trim()) {
        showError('Please enter a job description');
        return;
    }

    // Hide previous results and errors
    hideMessages();
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('loadingIndicator').style.display = 'none';
    
    // Show progress bar
    showSearchProgress();

    // Start search
    fetch('/api/search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            job_title: jobTitle || 'Position',
            job_description: jobDescription
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showError(data.error);
            hideSearchProgress();
        } else {
            currentSearchId = data.search_id;
            startSearchPolling();
        }
    })
    .catch(error => {
        showError('Search failed: ' + error.message);
        hideSearchProgress();
    });
}

function startSearchPolling() {
    searchCheckInterval = setInterval(checkSearchStatus, 2000);
    checkSearchStatus(); // Check immediately
}

let progressStep = 0;
let progressTimer = null;

function checkSearchStatus() {
    if (!currentSearchId) return;

    fetch(`/api/search/${currentSearchId}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'searching') {
                updateProgressDescription(data.progress || 'Searching candidates...');
            } else if (data.status === 'completed') {
                clearInterval(searchCheckInterval);
                completeProgress();
                setTimeout(() => {
                    hideSearchProgress();
                    displayResults(data.results);
                }, 1000);
            } else if (data.status === 'error') {
                clearInterval(searchCheckInterval);
                hideSearchProgress();
                showError(data.error || 'Search failed');
            }
        })
        .catch(error => {
            clearInterval(searchCheckInterval);
            hideSearchProgress();
            showError('Status check failed');
        });
}

function showSearchProgress() {
    document.getElementById('searchProgress').style.display = 'block';
    progressStep = 0;
    
    // Reset all steps
    document.querySelectorAll('.progress-step').forEach(step => {
        step.classList.remove('active', 'completed');
    });
    
    // Start step progression
    progressStep = 1;
    updateProgressStep();
    
    // Auto-progress through steps
    progressTimer = setInterval(() => {
        if (progressStep < 4) {
            progressStep++;
            updateProgressStep();
        }
    }, 3000); // Progress every 3 seconds
}

function hideSearchProgress() {
    document.getElementById('searchProgress').style.display = 'none';
    if (progressTimer) {
        clearInterval(progressTimer);
        progressTimer = null;
    }
}

function updateProgressStep() {
    const steps = ['analyzing', 'searching', 'ranking', 'finalizing'];
    const progressPercentages = [25, 50, 75, 90];
    
    // Update progress bar
    document.getElementById('progressBarFill').style.width = progressPercentages[progressStep - 1] + '%';
    
    // Update step states
    steps.forEach((stepName, index) => {
        const stepElement = document.getElementById(`step-${stepName}`);
        if (index + 1 < progressStep) {
            stepElement.classList.remove('active');
            stepElement.classList.add('completed');
            stepElement.querySelector('.step-icon').innerHTML = '<i class="fas fa-check"></i>';
        } else if (index + 1 === progressStep) {
            stepElement.classList.remove('completed');
            stepElement.classList.add('active');
            stepElement.querySelector('.step-icon').innerHTML = index + 1;
        } else {
            stepElement.classList.remove('active', 'completed');
            stepElement.querySelector('.step-icon').innerHTML = index + 1;
        }
    });
    
    // Update descriptions based on step
    const descriptions = [
        'Analyzing job requirements and extracting key skills',
        'Searching through resume database using AI matching',
        'Ranking candidates based on relevance and fit',
        'Finalizing results and preparing insights'
    ];
    
    if (progressStep <= descriptions.length) {
        updateProgressDescription(descriptions[progressStep - 1]);
    }
}

function completeProgress() {
    if (progressTimer) {
        clearInterval(progressTimer);
        progressTimer = null;
    }
    
    // Complete all steps
    document.querySelectorAll('.progress-step').forEach(step => {
        step.classList.remove('active');
        step.classList.add('completed');
        step.querySelector('.step-icon').innerHTML = '<i class="fas fa-check"></i>';
    });
    
    // Set progress bar to 100%
    document.getElementById('progressBarFill').style.width = '100%';
    updateProgressDescription('Search completed! Loading results...');
}

function updateProgressDescription(text) {
    const descElement = document.getElementById('progressDescription');
    // Remove dots animation temporarily
    descElement.innerHTML = text + '<span class="dots-animation"></span>';
}

function displayResults(results) {
    const container = document.getElementById('resultsContainer');
    container.innerHTML = '';
    
    if (!results || !results.candidates || results.candidates.length === 0) {
        container.innerHTML = '<p class="no-results">No matching candidates found</p>';
        document.getElementById('searchResults').style.display = 'block';
        return;
    }

    // Display summary
    const summary = document.createElement('div');
    summary.className = 'results-summary';
    summary.innerHTML = `
        <p><strong>Found ${results.total_found} candidates</strong></p>
        <p>${results.summary}</p>
    `;
    container.appendChild(summary);

    // Display candidates
    results.candidates.forEach((candidate, index) => {
        const card = document.createElement('div');
        card.className = 'candidate-card';
        
        const strengthsList = candidate.strengths.map(s => `<li>${s}</li>`).join('');
        const concernsList = candidate.concerns.length > 0 
            ? `<ul>${candidate.concerns.map(c => `<li>${c}</li>`).join('')}</ul>`
            : '<p>No concerns identified</p>';
        const experienceList = candidate.experience.map(e => `<li>${e}</li>`).join('');
        
        card.innerHTML = `
            <div class="candidate-header">
                <div class="candidate-rank">#${index + 1}</div>
                <div class="candidate-info">
                    <h3>${candidate.name}</h3>
                    <div class="match-score">
                        <span class="score-label">Match Score:</span>
                        <span class="score-value">${candidate.match_score}%</span>
                        <div class="score-bar">
                            <div class="score-fill" style="width: ${candidate.match_score}%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="candidate-body">
                <div class="rationale">
                    <h4><i class="fas fa-lightbulb"></i> Why this candidate?</h4>
                    <p>${candidate.rationale}</p>
                </div>
                
                <div class="candidate-details">
                    <div class="detail-section">
                        <h4><i class="fas fa-star"></i> Key Strengths</h4>
                        <ul>${strengthsList}</ul>
                    </div>
                    
                    <div class="detail-section">
                        <h4><i class="fas fa-briefcase"></i> Relevant Experience</h4>
                        <ul>${experienceList}</ul>
                    </div>
                    
                    <div class="detail-section">
                        <h4><i class="fas fa-exclamation-circle"></i> Potential Concerns</h4>
                        ${concernsList}
                    </div>
                </div>
            </div>
            
            <div class="candidate-actions">
                <button class="btn btn-sm btn-primary">
                    <i class="fas fa-user"></i> View Profile
                </button>
                <button class="btn btn-sm btn-secondary">
                    <i class="fas fa-download"></i> Download Resume
                </button>
                <button class="btn btn-sm btn-secondary" onclick="scheduleInterview('${candidate.id}')">
                    <i class="fas fa-envelope"></i> Schedule Interview
                </button>
            </div>
        `;
        
        container.appendChild(card);
    });

    document.getElementById('searchResults').style.display = 'block';
}

function showError(message) {
    hideMessages();
    const errorDiv = document.getElementById('errorMessage');
    document.getElementById('errorText').textContent = message;
    errorDiv.style.display = 'block';
}

function hideMessages() {
    document.getElementById('errorMessage').style.display = 'none';
}

// Add sample job description
function loadSampleJob() {
    document.getElementById('jobTitle').value = 'Senior Creative Designer';
    document.getElementById('jobDescription').value = `We are seeking a highly skilled Senior Creative Designer to join our dynamic marketing team. 

Requirements:
- 5+ years of professional design experience in advertising, branding, or digital media
- Expert-level proficiency in Adobe Creative Suite, particularly Photoshop, Illustrator, and InDesign
- Advanced Photoshop skills including photo retouching, compositing, and digital manipulation
- Strong experience in 3D modeling and rendering software (Cinema 4D, Blender, or Maya preferred)
- Experience with video editing and motion graphics (After Effects, Premiere Pro)
- Portfolio demonstrating expertise in photo editing, digital art creation, and brand design
- Experience with print and digital media design
- Bachelor's degree in Graphic Design, Visual Arts, or related creative field

Responsibilities:
- Create stunning visual content for marketing campaigns and brand materials
- Perform advanced photo retouching and image manipulation for product photography
- Design digital assets for web, social media, and mobile platforms
- Develop 3D models and renders for product visualization
- Maintain brand consistency across all visual communications`;
}

// Variables for email drafting
let currentDraftId = null;
let draftCheckInterval = null;

// Schedule interview function
function scheduleInterview(candidateId) {
    const jobTitle = document.getElementById('jobTitle').value;
    const jobDescription = document.getElementById('jobDescription').value;
    
    if (!jobDescription.trim()) {
        showError('Job description is required to draft email');
        return;
    }
    
    // Show the side pane and start drafting
    showEmailPane();
    startEmailDrafting(candidateId, jobDescription, jobTitle || 'Position');
}

function showEmailPane() {
    document.getElementById('emailSidePane').style.display = 'block';
    document.getElementById('emailPaneBackdrop').style.display = 'block';
    document.body.classList.add('side-pane-open');
}

function closeEmailPane() {
    document.getElementById('emailSidePane').style.display = 'none';
    document.getElementById('emailPaneBackdrop').style.display = 'none';
    document.body.classList.remove('side-pane-open');
    
    // Clear any ongoing polling
    if (draftCheckInterval) {
        clearInterval(draftCheckInterval);
        draftCheckInterval = null;
    }
    
    // Hide all pane content
    document.getElementById('emailLoadingIndicator').style.display = 'none';
    document.getElementById('emailDraftContent').style.display = 'none';
    document.getElementById('emailErrorMessage').style.display = 'none';
}

function startEmailDrafting(candidateId, jobDescription, jobTitle) {
    // Show loading
    document.getElementById('emailLoadingIndicator').style.display = 'block';
    document.getElementById('emailLoadingText').textContent = 'Creating personalized email...';
    
    // Start email drafting
    fetch('/api/draft_email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            candidate_id: candidateId,
            job_description: jobDescription,
            job_title: jobTitle,
            company_name: 'TechCorp'  // Could be made configurable
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showEmailError(data.error);
            document.getElementById('emailLoadingIndicator').style.display = 'none';
        } else {
            currentDraftId = data.draft_id;
            startDraftPolling();
        }
    })
    .catch(error => {
        showEmailError('Email drafting failed: ' + error.message);
        document.getElementById('emailLoadingIndicator').style.display = 'none';
    });
}

function startDraftPolling() {
    draftCheckInterval = setInterval(checkDraftStatus, 2000);
    checkDraftStatus(); // Check immediately
}

function checkDraftStatus() {
    if (!currentDraftId) return;

    fetch(`/api/draft/${currentDraftId}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'drafting') {
                document.getElementById('emailLoadingText').textContent = data.progress || 'Creating email draft...';
            } else if (data.status === 'completed') {
                clearInterval(draftCheckInterval);
                document.getElementById('emailLoadingIndicator').style.display = 'none';
                displayEmailDraft(data.draft);
            } else if (data.status === 'error') {
                clearInterval(draftCheckInterval);
                document.getElementById('emailLoadingIndicator').style.display = 'none';
                showEmailError(data.error || 'Email drafting failed');
            }
        })
        .catch(error => {
            clearInterval(draftCheckInterval);
            document.getElementById('emailLoadingIndicator').style.display = 'none';
            showEmailError('Status check failed');
        });
}

function displayEmailDraft(draft) {
    if (!draft) {
        showEmailError('No draft data received');
        return;
    }
    
    // Populate the email preview
    document.getElementById('emailSubject').value = draft.subject_line || '';
    document.getElementById('emailBody').value = draft.email_body || '';
    
    // Display time slots
    const timeSlotsList = document.getElementById('timeSlotsList');
    timeSlotsList.innerHTML = '';
    
    if (draft.time_slots && draft.time_slots.length > 0) {
        draft.time_slots.forEach((slot, index) => {
            const slotDiv = document.createElement('div');
            slotDiv.className = 'time-slot-item';
            slotDiv.innerHTML = `
                <i class="fas fa-clock"></i>
                <span>${slot}</span>
            `;
            timeSlotsList.appendChild(slotDiv);
        });
    } else {
        timeSlotsList.innerHTML = '<p>No available time slots found</p>';
    }
    
    // Show the email content
    document.getElementById('emailDraftContent').style.display = 'block';
}

function showEmailError(message) {
    hideEmailMessages();
    const errorDiv = document.getElementById('emailErrorMessage');
    document.getElementById('emailErrorText').textContent = message;
    errorDiv.style.display = 'block';
}

function hideEmailMessages() {
    document.getElementById('emailErrorMessage').style.display = 'none';
}

function copyEmailDraft() {
    const subject = document.getElementById('emailSubject').value;
    const body = document.getElementById('emailBody').value;
    
    const fullEmail = `Subject: ${subject}\n\n${body}`;
    
    navigator.clipboard.writeText(fullEmail).then(() => {
        showToast('Email draft copied to clipboard!', 'success');
    }).catch(err => {
        console.error('Failed to copy: ', err);
        showToast('Failed to copy email draft', 'error');
    });
}

function sendEmail() {
    // This would integrate with an email service
    showToast('Email sending feature coming soon!', 'info');
}

// Add keyboard shortcut for sample job
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.shiftKey && e.key === 'S') {
        loadSampleJob();
    }
    
    // ESC key to close email pane
    if (e.key === 'Escape') {
        closeEmailPane();
    }
});
</script>
{% endblock %}